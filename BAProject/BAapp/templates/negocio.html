{% extends 'base.html' %}
{% block imports %}
{% load static %}
{% load auth_extras %}
{% endblock imports %}
{% block title %}
Negociación {{ negocio.get_id_de_neg }}
{% endblock title %}
{%block body%}

<head>
  <link rel="stylesheet" type="text/css" href="{% static '/css/pages.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static '/css/old_vendedor.css' %}">
  <script type="text/javascript" src="{% static 'js/jquery.autocomplete.js' %}"></script>
  
  <link rel="stylesheet" type="text/css" href="{% static '/css/negocio.css' %}">
</head>





{% include "tempAux/loader.html" %}

{% if request.user.clase == 'Vendedor' %}

<div class="materialert error fixed" id="clienteAlert">
  <div class="material-icons">error_outline</div>
  Vista Cliente Activado
  <button type="button" class="close-alert" onclick="closeAlert('#clienteAlert');">×</button>
</div>

<div class="switch-container">
  <div class="switch">
    <label>
      Vista normal
      <input id="client-view-sw" type="checkbox">
      <span class="lever"></span>
      Vista cliente
    </label>
  </div>
</div>

{% endif %}


<!-- titulo -->
<div class="menuZone clv">
    <h4 class="tituloPagina">Negociación</h4>
    <strong style="font-size: 30px; font-weight: 900; color: #459A33; margin-left: 20px;" class="text-darken-3">{{negocio.get_id_de_neg}}</strong>
</div> 


{% for prop in propuestas %}

{% if not prop.items.count == 0 %}
{% include "negocio/table_history.html" %}
{% endif %}
 
{% if not negocio.estado == "ESP_CONF" or not request.user.clase == "Comprador" %}
{% if forloop.last %}
{% include "negocio/table_edit.html" %}
{% endif %}
{% endif %}

{% endfor %}

{% if negocio.estado == "CANCELADO" %}
<div class="canceled" id="canceled">
  <h2>Negocio cancelado ✗</h2>
  <p><strong>Negocio cerrado el {{negocio.fecha_cierre | date:"d/m/Y" }} a las {{negocio.fecha_cierre.time }} hs</strong></p>
</div>
{% endif %}
{% if negocio.estado == "ESP_CONF" and request.user.clase == "Comprador" %}
<div class="approved" id="approved">
  <h2>Esperando confirmación del vendedor ◌</h2>
  <p><strong>El vendedor está chequeando los datos. En cuanto lo haga, serás notificado vía e-mail.</strong></p>
</div>
{% endif %}

{% if negocio.estado == "CONFIRMADO" %}
<div class="approved" id="approved">
  <h2>Negocio confirmado ✓</h2>
  <p><strong>Negocio cerrado el {{negocio.fecha_cierre | date:"d/m/Y" }} a las {{negocio.fecha_cierre.time }} hs</strong></p>
  <a class="send-btn btn no-shadow waves-effect waves-effect waves-light" style="background-color: green;" id="modifyProp" onclick="addTable(); mScrollTo('#form');">Modificar propuesta</a>
</div>

<div id="table-destination">

  <div class="materialert warning" id="infoAlert">
    <div class="material-icons">warning</div>
    Debajo aparecerán las modificaciones que se realizaron posterior a la confirmación del negocio.
    <button type="button" class="close-alert" onclick="closeAlert('#infoAlert');">×</button>
  </div>

</div>
{% endif %}

<div class="fixed-action-btn">
  <a class="btn-floating btn-large">
    <i class="large material-icons">menu</i>
  </a>
  <ul>
    <li><a class="btn-floating bv-green tooltipped" data-position="left" data-tooltip="Ir a Info Negocio" href="{% url 'info_negocio' negocio.propuestas.last.id %}"><i class="material-icons">arrow_back</i></a></li>
    <li><a class="btn-floating bv-green tooltipped" data-position="left" data-tooltip="Ir arriba" id="btnScrollTop"><i class="material-icons">arrow_upward</i></a></li>
    {% if negocio.estado == "CONFIRMADO" %}
    <li><a class="btn-floating bv-green tooltipped" data-position="left" data-tooltip="Ir a Negocio confirmado" onclick="mScrollTo('#approved');"><i class="material-icons">date_range</i></a></li>
    {% endif %}
    <li><a class="btn-floating bv-green tooltipped" data-position="left" data-tooltip="Ir abajo" id="btnScrollBottom"><i class="material-icons">arrow_downward</i></a></li>
  </ul>
</div>

<script src="{% static 'js/negocio.js' %}"></script>

<script type="text/javascript">

  var isAccepted = false;
  var isCanceled = false;
  var propUpdated = false;
  var arts_data;
  var unsavedChanges = false;

  var last = {{ last | safe }};
  var edits = $.extend(deep=true, {}, last);
  var editable_fields = [
    "distribuidor",
    "precio_venta",
    "precio_compra",
    "cantidad",
    "tipo_pago",
    "tasa",
    "destino",
    "fecha_entrega",
    "fecha_pago",
    "observaciones"
  ]
  var headers = []
  var listProp = [];

  $(document).ready(function(){
    edits.new = {}
    
    "{% if negocio.estado == 'CONFIRMADO' %}"
    isAccepted = true;
    "{% endif %}"
    "{% if negocio.estado == 'CANCELADO' %}"
    isCanceled = true;
    "{% endif %}"

    if (isAccepted || isCanceled) {
      $("#form-table-div").hide();
    }

    if (!isAccepted) {
      $.ajax({
        type: "GET",
        url: "{% url 'api_articulos' %}",
        dataType: "json",
        success: function(data) {      
          arts_data = data;
          articuloDatalist(); // agrega los articulos a la datalist de table_edit
        }
      });
    }

    // scroll hasta tabla editable o en su defecto, a aviso de negocio aprobado o cancelado
    var elId;
    "{% if negocio.estado == 'CONFIRMADO' or negocio.estado == 'ESP_CONF' and request.user.clase == 'Comprador' %}"
    elId = "#approved"
    "{% elif negocio.estado == 'CANCELADO' %}"
    elId = "#canceled"
    "{% else %}"
    elId = "#form-table-div"
    "{% endif %}"
    if (elId) {
      setTimeout(function() {
          mScrollTo(elId);
      }, 500);
    }

    listProp.push('0');

  });


  var userIsComprador = false;
  "{% if request.user.clase == 'Comprador' %}"
  userIsComprador = true;
  "{% endif %}"

  if (userIsComprador) {
    $(".customerHide").hide();
  }
  
  var lastForAccept = last;

  function accept(index){
    console.log("accept")
    if (!userIsComprador) {
      var input = $($("#form")[0].rows[index+1]).find('[name="distribuidor"]')[0]
      if (edits.items[index].proveedor == null) {
        $(input).addClass("invalid");
        return;
      }
    }
    resetForAccept(index)
    edits.items[index].aceptado = true;
    $($("#form")[0].rows[index+1]).css('background-color', '#4CB8484A');
    $('#send-prop-btn').removeAttr('disabled');
    propUpdated = true;
  }

  function reject(index){
    console.log("rejected")
    resetAll(index, "False")
    $($("#form")[0].rows[index+1]).css('background-color', '#EE8A8A');
    edits.items[index]={};
    $('#send-prop-btn').removeAttr('disabled');
    propUpdated = true;
  }

  function update(index){
    console.log("update");
    if (!userIsComprador && edits.items[index].proveedor == null) {
      var input = $($("#form")[0].rows[index+1]).find('[name="distribuidor"]')[0];
      if (input.value == "") {
        $(input).addClass("invalid");
        return;
      }
      else {
        $(input).removeClass("invalid");
      }
    }
    $($("#form")[0].rows[index+1]).css('background-color', '#FDDA77');
    editable_fields.forEach(element => {
      if (element != "observaciones") {
        var input = $($("#form")[0].rows[index+1]).find('[name="'+element+'"]')[0]
        if (input != null) {
          if (input.type == "number"){
            if (input.name == "precio_venta" || input.name == "precio_compra") {
              edits.items[index][element] = parseFloat(input.value)
            }
            else {
              edits.items[index][element] = parseInt(input.value)
            }
          }
          else if (input.name == "distribuidor"){
            var opt = $("#distResults [value='"+input.value+"']");
            edits.items[index]["proveedor"] = opt.data('value');
          } else {
            edits.items[index][element] = input.value
          }
        }
      }
    })
    lastForAccept.items[index] = edits.items[index]
    $('#send-prop-btn').removeAttr('disabled');
    $('#conf-neg-btn').attr("disabled", 'disabled');
    propUpdated = true;
    unsavedChanges = false;
    console.log($("#save-" + index).removeClass("blinkSave"));
  }

  function resetAll(index, aceptado){
    console.log("resetAll");
    if (aceptado == "False") {
      $($("#form")[0].rows[index+1]).css('background-color', '');
    }
    edits.items[index] = Object.assign({},last.items[index]);
    editable_fields.forEach(element => {
      var input = $($("#form")[0].rows[index+1]).find('[name="'+element+'"]');
      if (element == "tipo_pago" || element == "tasa") {
        input.val(edits.items[index][element]).change();
      }
      else {
        input.val(edits.items[index][element]);
      }
    });
    unsavedChanges = false;
    // console.log($("#save-" + index).removeClass("blinkSave"));
  }

  function resetForAccept(index) {
    console.log("resetForAccept");
    $($("#form")[0].rows[index+1]).css('background-color', '');
    edits.items[index] = Object.assign({},lastForAccept.items[index]);
    editable_fields.forEach(element => {
      var input = $($("#form")[0].rows[index+1]).find('[name="'+element+'"]')
      if (element == "tipo_pago" || element == "tasa") {
        input.val(edits.items[index][element]).change()
      }
      else if (element == "distribuidor") {
        // do nothing
      }
      else {
        input.val(edits.items[index][element])
      }
    });
  }

  function removeUpdate(index) {
    editable_fields.forEach(element => {
      if (element != "observaciones") {
        var input = $($("#form")[0].rows[index+1]).find('[name="'+element+'"]')[0]
        if (input != null) {
          var inputValue = input.value;
          var updatedElementValue = lastForAccept.items[index][element];
          if (element == "tasa") {
            updatedElementValue = parseFloat(lastForAccept.items[index][element])
          }
          unsavedChanges = (inputValue == updatedElementValue) || unsavedChanges;
        }
      }
    });
    if (unsavedChanges) {
      $($("#form")[0].rows[index+1]).css('background-color', '');
      console.log($("#save-" + index).addClass("blinkSave"));
    }
  }

  var counter = 0;

  function addArt(){
    var n = {}, errors=false;
    var rowId = "NewRow"+counter
    console.log("addArt");
    headers.push("divisa");
    headers.forEach(element => {
      if (userIsComprador) {
        if (element == "precio") {
          element = "precio_venta";
        }
      }
      var input = null;
      if (element != "divisa") {
        input = $($("#extra").find('[name="'+element+'"]'))[0];
      }
      var artSearchInput = $("#artSearch").val();
      var artId = parseInt($('#artDatalist option[value="' + artSearchInput +'"]').attr("id"));
      if (input != null) {
        if (!input.value) {
          if (userIsComprador) {
            if (!(input.name == "distribuidor" || input.name == "precio_compra")) {
              errors = true || errors;
              if (input.name == "tipo_pago") {
                $(input).parent().addClass("invalid");
              }
              else {
                $(input).addClass("invalid");
              }
            }
          } else {
            errors = true || errors;
            if (input.name == "tipo_pago") {
              $(input).parent().addClass("invalid");
            }
            else {
              $(input).addClass("invalid");
            }
          }
          $(input).addClass("invalid");
          if (input.name == "tipo_pago") {
            input.parentElement.classList.add("select-error");
          }
        } else {
          errors = false || errors
          $(input).removeClass("invalid");
        }
        if (element === "distribuidor") {
          element = "proveedor";
          var opt = $("#distResults [value='"+input.value+"']");
          n[element] = opt.data('value');
        } else {
          if (input.type == "number" || input.type == "hidden") {
            if (input.name == "precio_venta" || input.name == "precio_compra" || input.name == "tasa") {
              n[element] = parseFloat(input.value);
            }
            else {
              n[element] = parseInt(input.value);
            }
          } else {
            n[element] = input.value;
            n["articulo"] = artId;
            n["pagado"] = false;
            n["fecha_real_entrega"] = null;
            n["fecha_real_pago"] = null;
            n["fecha_salida_entrega"] = null;
            n["divisa"] = "USD";
            if (userIsComprador) {
              n["proveedor"] = null;
              n["precio_compra"] = 0;
            }
          }
        }
      }
    })
    if (errors){
      return;
    }
    n.aceptado = false;

    edits.items.push(n);

    var tipo_pago = "";

    "{% for tipo_pago in tipo_pagos %}"
    if (parseInt("{{tipo_pago.id}}") == n.tipo_pago) {
      tipo_pago = "{{tipo_pago.nombre}}";
    }
    "{% endfor %}"

    if (sm) {
      showMore(0);
    }

    if (tipo_pago.toLowerCase() == "contado") {
      n.tasa = 0;
    }

    var table = $("#form")[0]
    var row = table.insertRow(table.rows.length-1)
    row.innerHTML = "\
    <td class=\"show0\">"+$("#artSearch")[0].value+"</td>\
    {% if not request.user.clase == 'Comprador' %}\
    <td class=\"show0\">"+$("#distSearch")[0].value+"</td>\
    {% endif %}\
    <td class=\"show0\"><input type=\"number\" name=\"cantidad\" value=\""+n.cantidad+"\" placeholder=\"Cantidad\" onkeyup=\"removeUpdate("+(table.rows.length-3)+")\"></td>\
    <td class=\"show0\"><input type=\"number\" name=\"precio_venta\" step=\".01\" value="+n.precio_venta+" placeholder=\"{% if not request.user.clase == 'Comprador' %}Precio venta{% else %}Precio{% endif %}\" onkeyup=\"removeUpdate("+(table.rows.length-3)+")\"></td>\
    {% if not request.user.clase == 'Comprador' %}\
    <td class=\"show0\"><input type=\"number\" name=\"precio_compra\" step=\".01\" value=\""+n.precio_compra+"\" placeholder=\"Precio compra\" onkeyup=\"removeUpdate("+(table.rows.length-3)+")\"></td>\
    {% endif %}\
    <td class=\"{% if request.user.clase == 'Comprador' %}show0{% elif request.user.clase == 'Vendedor' %}not-show0{%endif%}\"><select name=\"tipo_pago\" id=\"tp"+rowId+"\" onchange=\"contadoTasa('"+rowId+"'); removeUpdate("+(table.rows.length-3)+")\"><option value=\""+n.tipo_pago+"\" selected disabled>"+tipo_pago+"</option>{% for tipo_pago in tipo_pagos %}<option value=\"{{ tipo_pago.id }}\">{{ tipo_pago.nombre }}</option>{% endfor %}</select></td>\
    <td class=\"not-show0\"><input type=\"number\" name=\"tasa\" id=\"tas"+rowId+"\" value=\""+n.tasa+"\" placeholder=\"Tasa\" onkeyup=\"removeUpdate("+(table.rows.length-3)+")\"></td>\
    <td class=\"not-show0\"><input type=\"text\" name=\"fecha_pago\" value=\""+n.fecha_pago+"\" placeholder=\"Fecha pago\" onkeyup=\"removeUpdate("+(table.rows.length-3)+")\"></td>\
    <td class=\"not-show0\"><input type=\"text\" name=\"fecha_entrega\" value=\""+n.fecha_entrega+"\" placeholder=\"Fecha entrega\" onkeyup=\"removeUpdate("+(table.rows.length-3)+")\"></td>\
    <td class=\"not-show0\"><input type=\"text\" name=\"destino\" value=\""+n.destino+"\" placeholder=\"Destino\" onkeyup=\"removeUpdate("+(table.rows.length-3)+")\"></td>\
    <td>\
      <a class=\"action-btn btn-small bv-red btn-floating waves-effect waves-light tooltipped\" data-position=\"top\" data-tooltip=\"Eliminar\" onclick=\"reject("+(table.rows.length-3)+")\"><i class=\"material-icons table-icons\">delete</i></a>\
      <a class=\"action-btn btn-small bv-yellow btn-floating waves-effect waves-light tooltipped\" data-position=\"top\" data-tooltip=\"Guardar Ediciones\" onclick=\"update("+(table.rows.length-3)+")\" id=\"save-"+(table.rows.length-3)+"\"><i class=\"material-icons table-icons\">save</i></a>\
    </td>\
    <td>\
      <a class=\"action-btn btn-floating btn waves-effect waves-green transparent no-shadows\" onclick=\"showMore(0);\"><i class=\"i1 material-icons table-icons\" style=\"color: #459A33;\">search</i></a>\
    </td>\
    ";
    $('select').formSelect();
    headers.forEach(element => {
      if (userIsComprador && element == "precio") {
        element = "precio_venta";
      }
      var input = $($("#extra").find('[name="'+element+'"]'))
      input.val("");
      input.removeClass(["invalid"])
    })
    $('select').formSelect();
    $("#artSearch").val("");
    counter = counter + 1;
    contadoTasa(rowId);
    contadoTasa('Add');
    $('#send-prop-btn').removeAttr('disabled');
    propUpdated = true;
    allTDLinebreak();
  }

  var obsOriginalValue = $("#observaciones").val();
  $("#observaciones").on('keyup', function () {
    $('#send-prop-btn').removeAttr('disabled');
    if ($(this).val() == obsOriginalValue && !propUpdated) {
      $('#send-prop-btn').attr('disabled', 'disabled');
    } 
  });

  function beforeSubmit(isSend) {
    var proc = {}
    var errors = false;
    var errorFields = [];
    proc.observaciones = $("#observaciones").val();
    proc.items = [];
    edits.items.forEach(element => {
      if (element.hasOwnProperty("articulo")){
        proc.items.push(element)
      }
    })
    var acc = []
    var count = 0;
    proc.items.forEach(element => {
      for (k in element) {
        if (k == "aceptado") {
          var v = element[k];
          acc.push(v);
        }
      }
      count++;
    })
    if (count == 0) {
      acc = [false];
    }
    var checker = arr => arr.every(Boolean);
    var icon, title, text;
    if (checker(acc) && !isSend) {
      icon = "success";
      title = "Confirmar negocio";
      text = "Estás a punto de confirmar el negocio.\n¿Deseas continuar con la operación?";
    }
    else if (count == 0) {
      icon = "error";
      title = "Cancelar negocio";
      text = "Estás a punto de cancelar el negocio.\n¿Deseas continuar con la operación?";
    }
    else {
      icon = "warning";
      title = "Enviar propuesta";
      text = "Estás a punto de enviar una nueva propuesta.\n¿Deseas continuar con la operación?";
    }
    if (unsavedChanges) {
      swal({
        title: "Cambios sin guardar",
        text: "Revisá si algún botón de guardado parpadea,\nsi es así, guardá los cambios.\n¿Deseas continuar?",
        buttons: {
          cancel: "No",
          confirm: "Si",
        },
        icon: "info"
      }).then(okay => {
        if (okay) openSwalForSubmit(icon, title, text, isSend);
      });
    }
    else {
      openSwalForSubmit(icon, title, text, isSend);
    }
  }

  function openSwalForSubmit(icon, title, text, isSend) {
    swal({
      icon: icon,
      title: title,
      text: text,
      buttons: {
        cancel: "No",
        confirm: "Si",
      }
    }).then(okay => {
      if (okay) submitProp(isSend);
    });
  }

  function submitProp(isSend) {
    var proc = {}
    var errors = false;
    var errorFields = {};
    proc.issend = isSend;
    proc.observaciones = $("#observaciones").val();
    proc.items = [];
    edits.items.forEach(element => {
      if (element.hasOwnProperty("articulo")){
        proc.items.push(element)
      }
    })
    var elems = ["id", "propuesta", "aceptado", "pagado", "fecha_real_pago", "fecha_salida_entrega", "fecha_real_entrega", "divisa", "tasa"];
    var artName = "";
    var listOfErrors = []
    var listOfElems = []
    proc.items.forEach(element => {
      for (k in element) {
        if (k == "articulo") {
          "{% for art in arts %}"
            var artId = parseInt("{{art.id}}");
            if (artId == element[k]) {
              artName = "{{art}}";
            }
          "{% endfor %}"
        }
        if (!(jQuery.inArray(k, elems) != -1)) {
          if (element.hasOwnProperty(k)) {
            var v = element[k];
            k = k == "precio_venta" ? "precio" : k; 
            var errorDesc = "\t- El campo \""+k+"\" contiene errores.\n"
            if (!v) {
              if (!(userIsComprador && ((k == "precio_compra") || (k == "proveedor")))) {
                listOfErrors.push(errorDesc)
                errorFields[artName] = listOfErrors;
                errors = true;
              }
            }
          }
        }
      }
      listOfElems.push(element)
      for (i in listOfElems) {
        if (listOfElems[i] != listOfElems[i-1]) {
          listOfErrors = [];
        }
      }
    })
    console.log(errorFields)
    console.log(proc);
    var print_errors = "";
    for (var key in errorFields) {
      print_errors = print_errors.concat(key + ':\n' + errorFields[key]+'\n').replace(',','');
    }
    if (errors) {
      swal({
        title: "Oops!",
        text: print_errors,
        buttons: false,
        icon: "error"
      });
    }
    else {
      fetch("",{
        method:'POST',
        headers: {
          [window.drf.csrfHeaderName]: window.drf.csrfToken,
          'Content-Type':'application/json',
        },
        body: JSON.stringify(proc),
      })
        .then(a => {location.reload()})
        .catch(a => {console.log(a)})
    }
  }
</script>
{%endblock body%}