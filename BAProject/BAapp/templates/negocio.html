{% extends 'base.html' %}
{% load auth_extras %}
{% block imports %}
   {% load static %}
   <script type="text/javascript" src="{% static 'js/jquery.autocomplete.js' %}"></script>
{% endblock imports %}
{% block style %}

body {
  background-color: #fff;
}

.autocomplete-suggestions {
    background-color: #fff;
    box-shadow: 0 2px 2px 0 rgba(0,0,0,0.14), 0 1px 5px 0 rgba(0,0,0,0.12), 0 3px 1px -2px rgba(0,0,0,0.2);
    max-height: 650px;
    min-width: 100px;
    overflow-y: auto;
    will-change: width, height;
    z-index: 999;
}
  .autocomplete-suggestion,
  .autocomplete-no-suggestion {
    clear: both;
    color: #26a69a;
    color: rgba(0,0,0,0.87);
    cursor: pointer;
    display: block;
    font-size: 16px;
    line-height: 1.5rem;
    line-height: 22px;
    min-height: 50px;
    padding: 14px 16px;
    text-align: left;
    text-transform: none;
    width: 100%;
  }

  &.autocomplete-selected {
    background-color: #888;
  }
  .show0 {
  }
  .not-show0 {
    display: none;
  }
  .datepicker-day-button {
    color: black;
  }
  .datepicker-row > .is-selected > .datepicker-day-button {
    color: white !important;
  }
  .datepicker-row > .is-today > .datepicker-day-button {
    color: #26a69a;
  }
  .i1 {
    -webkit-transition: all .4s ease;
    -moz-transition: all .4s ease;
    -ms-transition: all .4s ease;
    -o-transition: all .4s ease;
    transition: all .4s ease;
  }
  .rotate {
    transform: rotate(180deg);
    -webkit-transform: rotate(180deg);
    -moz-transform: rotate(180deg);
    -o-transform: rotate(180deg);
    -ms-transform: rotate(180deg);
  }
  table.striped > tbody > tr:nth-child(odd) {
    background-color: #e0e0e0;
  }
  .action-btn {
    margin: 1px !important;
  }
  .approved {
    text-align: center;
    color: green;
    margin: 100px;
  }
  .canceled {
    text-align: center;
    color: red;
    margin: 100px;
  }
  .menu{
    background-color: #005221;
    border-top-right-radius: 3em;
    border-bottom-right-radius: 3em;
    margin-top: 2%;
    color: white;
    min-width: 405px;
  }
  .h-bar {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .btn-small {
    height: 24px;
    line-height: 24px;
    padding: 0 0.5rem;
    -webkit-box-shadow: none !important;
    -moz-box-shadow: none !important;
    box-shadow: none !important;
  }
  .table-icons {
    display: table-cell !important;
    vertical-align: middle;
    line-height:32px !important;
    height:100% !important;
  }
  .no-shadow {
    -webkit-box-shadow: none !important;
    -moz-box-shadow: none !important;
    box-shadow: none !important;
  }
  .bv-green:hover, .bv-red:hover, .bv-yellow:hover, .bv-blue:hover, .bv-gray:hover {
    background-color: #005221;
  }
  .prop-creator-name {
    font-size: 26px;
    margin: 0;
    padding: 0;
    display: inline;
  }
  .prop-date {
    font-size: 20px;
    margin: 0;
    padding: 0;
    display: inline;
  }
  .card {
    position: relative;
    background-color: #ececee !important;
    border-radius: 2rem !important;
    -webkit-box-shadow: none !important;
    -moz-box-shadow: none !important;
    box-shadow: none !important;
    min-width: 925px;
    z-index: 1;
  }
  .card-action {
    border-bottom-left-radius: 2rem !important;
    border-bottom-right-radius: 2rem !important;
    margin: 0;
    padding: 0;
    background-color: transparent !important;
  }
  tr {
    border: none !important;
  }
  td, th {
    width: 1%;
    white-space: nowrap;
    padding: 3px;
  }
  div.row > table > thead > tr {
    color: #717275;
    font-weight: 700;
  }
  div.row > table > tbody > tr, input, textarea, div.card-action > p {
    color: #717275;
    font-weight: 500;
  }
  div.row > table > thead > tr > th {
    border-radius: 0 !important;
    
  }
  div.row > table > tbody > tr > td {
    border-radius: 0 !important;
  }
  .send-btn {
    border-radius: 2rem !important;
  }
  span.obser {
    color: #717275;
    font-weight: 700;
  }
  .container__wrapper {
    z-index: -1;

    align-items: center;
    display: flex;
    justify-content: center;

    left: 0px;
    position: absolute;
    top: 0px;

    height: 100%;
    width: 100%;
  }

  .container__watermark > img {
    margin: 70px;
    opacity: 0.8;
    user-select: none;
  }
  .white-text-input > td > input {
    color: white;
    border-bottom: 1px solid white !important;
  }
  .white-text-input > td > div > input {
    color: white;
    border-bottom: 1px solid white !important;
  }
  @media only screen and (max-width: 1200px) {
    .container__watermark > img {
      margin: 10px;
    }
  }
  .materialert {
    position: relative;
    min-width: 150px;
    width: 50%;
    margin: 0 auto;
    padding: 15px;
    margin-bottom: 20px;
    margin-top: 15px;
    border: 1px solid transparent;
    border-radius: 4px;
    transition: all 0.1s linear;
    webkit-box-shadow: 0 2px 2px 0 rgba(0,0,0,0.14), 0 3px 1px -2px rgba(0,0,0,0.12), 0 1px 5px 0 rgba(0,0,0,0.2);
    box-shadow: 0 2px 2px 0 rgba(0,0,0,0.14), 0 3px 1px -2px rgba(0,0,0,0.12), 0 1px 5px 0 rgba(0,0,0,0.2);
    display: -webkit-box;
    display: -webkit-flex;
    display: -ms-flexbox;
    -webkit-box-align: center;
    -webkit-align-items: center;
    -ms-flex-align: center;
    align-items: center;
  }
  .materialert .close-alert{
    -webkit-appearance: none;
    border: 0;
    cursor: pointer;
    color: inherit;
    background: 0 0;
    font-size: 22px;
    line-height: 1;
    font-weight: bold;
    text-shadow: 0 1px 0 rgba(255, 255, 255, .7);
    filter: alpha(opacity=40);
    margin-bottom: -5px;
    position: absolute;
    top: 16px;
    right: 5px;
  }
  .materialert .material-icons {
      margin-right: 10px;
  }
  .materialert.error {
    background-color: #c62828;
    color: #fff;
  }
  .materialert.warning {
    background-color: #fec80b;
    color: #000;
    margin-top: 50px;
    margin-bottom: 50px;
  }
  .materialert.fixed {
    transform: translateY(-100px);
    left: 25%;
    position: fixed;
    z-index: 99;
    display: none;
  }
  @keyframes alertAnimDown {
    0% {
      transform: translateY(-100px);
    }
    
    100% {
      transform: translateY(0);
    }
  }
  @keyframes alertAnimUp {
    0% {
      transform: translateY(0);
    }
    
    100% {
      transform: translateY(-100px);
    }
  }
  .switch-container {
    position: fixed;
    z-index: 99;
    left: 0;
    bottom: 0;
    background-color: #005321;
    padding: 20px;
    margin: 10px;
    border-radius: .5rem;
    opacity: .1;
    transition: opacity .2s;
  }
  .switch-container:hover {
    opacity: 1;
  }
  .switch > label {
    color: white !important;
  }
  .switch label input[type=checkbox]:checked+.lever {
      background-color: #a6a6a6;
  }
  .switch label input[type=checkbox]:checked+.lever:after {
      background-color: #737373;
  }
{% endblock %}
{% block title %}Negociación{% endblock title %}
{%block body%}

{% if request.user|has_group:'Vendedor' %}

<div class="materialert error fixed">
  <div class="material-icons">error_outline</div>
  Vista Cliente Activado
</div>

<div class="switch-container">
  <div class="switch">
    <label>
      Vista normal
      <input id="client-view-sw" type="checkbox">
      <span class="lever"></span>
      Vista cliente
    </label>
  </div>
</div>

{% endif %}

<div class="row">
  <div style="height: 80px;" class="menu col l4 m4 s4"> 
    <div class="row">
      <div class="col l3 s3 ">
        <div style="height: 95px; width: 95px; position: relative; bottom: 5px; background-color: white; border-radius: 50%; text-align: center;" class="col-s2 h-bar">
          <img src="{% static 'images/check.svg' %}" alt="Check icon">
        </div>
      </div>
      <h4 class="col l9 s9" style="font-weight: 500;"> Negociación</h4>
    </div>    
  </div>
  <div style="height: 80px; margin-top: 2%; position: relative;" class="col l4 m4 s4">
    <div style="margin: 0; position: absolute; top: 50%; -ms-transform: translateY(-50%); transform: translateY(-50%);">
      <strong style="font-size: 30px; font-weight: 900;" class="grey-text text-darken-3">{{negocio.id_de_neg}}</strong>
    </div>
  </div>
</div>
{% for prop in propuestas %}
<style>
  .show{{prop.id}} {
    }
  .not-show{{prop.id}} {
    display: none;
  }
  .i{{prop.id}} {
    -webkit-transition: all .4s ease;
    -moz-transition: all .4s ease;
    -ms-transition: all .4s ease;
    -o-transition: all .4s ease;
    transition: all .4s ease;
  }
</style>
{% if not prop.items.count == 0 %}
<div class="row" id="div-table-{{prop.id}}">
  <div class="col s12 m9 {% if prop.envio_comprador and request.user|has_group:'Comprador' %}push-m3{% elif not prop.envio_comprador and request.user|has_group:'Vendedor' %}push-m3{%endif%}">
    <div class="prop-title">
      <p class="prop-creator-name grey-text text-darken-3"><strong>{% if prop.envio_comprador %} {{ negocio.comprador.persona.user.get_full_name }} - {{ negocio.comprador.empresa }} {% else %} {{ negocio.vendedor.persona.user.get_full_name }} {% endif %}</strong></p>
      <p class="prop-date grey-text text-darken-4">{{ prop.timestamp|date:"d/m/Y H:i" }} hs</p>
    </div>
    <div class="card">
      <div class="container__wrapper">
        <div class="container__watermark">
          <img class="w1" src="{% static 'images/logo-16.png' %}" height="180px" alt="watermark">
        </div>
        <div class="container__watermark">
          <img class="w2" src="{% static 'images/logo-16.png' %}" height="180px" alt="watermark">
        </div>
        <div class="container__watermark">
          <img class="w3" src="{% static 'images/logo-16.png' %}" height="180px" alt="watermark">
        </div>
      </div>
      <div class="card-content dark-text">
        <div class="row">
          <table>
            <thead>
              <tr>
                <th class="show{{prop.id}}">Articulo</th>
                {% if not request.user|has_group:'Comprador' %}
                <th class="show{{prop.id}} clientViewSM">Distribuidor</th>
                {% endif %}
                <th class="show{{prop.id}}">Cantidad</th>
                <th class="show{{prop.id}}">{% if not request.user|has_group:'Comprador' %}Precio venta{% else %}Precio{% endif %}</th>
                {% if not request.user|has_group:'Comprador' %}
                <th class="show{{prop.id}} clientViewSM">Precio compra</th>
                {% endif %}
                <th class="{% if request.user|has_group:'Comprador' %}show{{prop.id}}{% elif request.user|has_group:'Vendedor' %}not-show{{prop.id}}{%endif%}">Tipo pago</th>
                <th class="not-show{{prop.id}} clientView">Tasa</th>
                <th class="not-show{{prop.id}} clientView">Fecha pago</th>
                <th class="not-show{{prop.id}} clientView">Fecha entrega</th>
                <th class="not-show{{prop.id}} clientView">Destino</th>
                <th class="clientViewSM">Ver más</th>
              </tr>
            </thead>
            <tbody>
            {% for item in prop.items.all %}
              <tr {% if item.aceptado %}class="green white-text"{% endif %}>
                <td class="show{{prop.id}}">{{ item.articulo.marca }}</td>
                {% if not request.user|has_group:'Comprador' %}
                <td class="show{{prop.id}} clientViewSM">{{ item.proveedor|default_if_none:'' }}</td>
                {% endif %}
                <td class="show{{prop.id}}">{{ item.cantidad }}</td>
                <td class="show{{prop.id}}">{{ item.precio_venta }}</td>
                {% if not request.user|has_group:'Comprador' %}
                <td class="show{{prop.id}} clientViewSM">{{ item.precio_compra|default_if_none:"0,0" }}</td>
                {% endif %}
                <td class="{% if request.user|has_group:'Comprador' %}show{{prop.id}}{% elif request.user|has_group:'Vendedor' %}not-show{{prop.id}}{%endif%} ">{{ item.tipo_pago|default_if_none:"Sin definir" }}</td>
                <td class="not-show{{prop.id}} clientView">{{ item.tasa }}%</td>
                <td class="not-show{{prop.id}} clientView">{{ item.fecha_pago|default:"Sin definir" }}</td>
                <td class="not-show{{prop.id}} clientView">{{ item.fecha_entrega|default:"Sin definir" }}</td>
                <td class="not-show{{prop.id}} clientView">{{ item.destino|default:"Sin definir" }}</td>
                <td class="clientViewSM">
                  <a class="action-btn btn-small bv-gray btn-floating waves-effect waves-light" id="btn-sm-{{prop.id}}" onclick="showMore({{prop.id}}); sm{{prop.id}}=!sm{{prop.id}};"><i class="i{{prop.id}} material-icons table-icons">search</i></a>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-action">
        <span class="obser">Observaciones:</span>
        <p>{{ prop.observaciones|default_if_none:'No hay observaciones'|default:'No hay observaciones' }}</p>
      </div>
    </div>
  </div>
</div>
<script>
  // var btn_sm_{{prop.id}} = document.getElementById('btn-sm-{{prop.id}}');

  // $(btn_sm_{{prop.id}}).each(function () {
  //   $('[id="' + this.id + '"]:gt(0)').remove();
  // });

  var sm{{prop.id}} = false;
  var propIdId = "{{prop.id}}";

  $("#client-view-sw").change(function() {

    if($(this).is(":checked")) {
  
      var propId = "{{prop.id}}";
      if (sm{{prop.id}}) {
        showMore(propId);
        sm{{prop.id}} = !sm{{prop.id}};
      }

    }
    else {

      var propId = "{{prop.id}}";
      if (sm{{prop.id}}) {
        showMore(propId);
        sm{{prop.id}} = !sm{{prop.id}};
      }
    }

    
  });
  
  $(document).ready(function() {
    listProp.push("{{prop.id}}");
  });
  
</script>

{% if negocio.aprobado %}
<script>
  $(document).ready(function () {
    var isBeforeFechaCierre = false;
    var fechaProp = "{{prop.timestamp|date:'c'}}";
    var fechaCierreNeg = "{{negocio.fecha_cierre|date:'c'}}";
    
    if (Date.parse(fechaProp) <= Date.parse(fechaCierreNeg)) {
      isBeforeFechaCierre = true;
    }

    addTables("{{prop.id}}", isBeforeFechaCierre);

  });
</script>
{% endif %}

{% endif %}
{% if forloop.last %}
<div class="row" id="form-table-div">
  <div class="col s12 m9 push-m3">
    <div class="prop-title">
      <p class="prop-creator-name grey-text text-darken-3"><strong>Nueva propuesta</strong></p>
    </div>
    <div class="card">
      <div class="container__wrapper">
        <div class="container__watermark">
          <img class="w1" src="{% static 'images/logo-16.png' %}" height="180px" alt="watermark">
        </div>
        <div class="container__watermark">
          <img class="w2" src="{% static 'images/logo-16.png' %}" height="180px" alt="watermark">
        </div>
        <div class="container__watermark">
          <img class="w3" src="{% static 'images/logo-16.png' %}" height="180px" alt="watermark">
        </div>
      </div>
      <div class="card-content dark-text">
        <div class="row">
          <table {% if forloop.last %}id="form"{%endif%}>
            <thead>  
              <tr>
                <th class="show0">Articulo</th>
                <th class="show0 {% if request.user|has_group:'Comprador' %}customerHide{% endif %}">Distribuidor</th>
                <th class="show0">Cantidad</th>
                <th class="show0">{% if not request.user|has_group:'Comprador' %}Precio venta{% else %}Precio{% endif %}</th>
                <th class="show0 {% if request.user|has_group:'Comprador' %}customerHide{% endif %}">Precio compra</th>
                <th class="{% if request.user|has_group:'Comprador' %}show0{% elif request.user|has_group:'Vendedor' %}not-show0{%endif%}">Tipo pago</th>
                <th class="not-show0">Tasa</th>
                <th class="not-show0">Fecha pago</th>
                <th class="not-show0">Fecha entrega</th>
                <th class="not-show0">Destino</th>
                <th>Operaciones</th>
                <th>Ver más</th>
              </tr>
            </thead>
            <tbody>
            {% for item in prop.items.all %}
              <tr {% if item.aceptado %}class="green white-text white-text-input"{% endif %}>
                {% if item.articulo.marca == "NINGUNA" %}
                  <td class="show0">{{ item.articulo.ingrediente|default_if_none:'' }}</td>
                {% else %}
                  <td class="show0">{{ item.articulo.marca|default_if_none:'' }}</td>
                {% endif %}
                {% if not request.user|has_group:'Comprador' %}
                <td class="show0">
                  {% if item.proveedor == None %}
                  <input type='text' name='distribuidor' id='distSearch{{ forloop.counter0 }}' list='distResults' autocomplete='off'>
                  <datalist id='distResults'>
                  {% for dist in distribuidores %}
                    <option data-value="{{ dist.id }}" value="{{ dist.persona }}"></option>
                  {% endfor %}
                  </datalist>
                  {% else %}
                  {{ item.proveedor }}
                  {% endif %}
                </td>
                {% endif %}
                <td class="show0"><input type="number" name="cantidad" value="{{ item.cantidad|default_if_none:'' }}"></td>
                <td class="show0"><input type="number" name="precio_venta" step=".01" value="{{ item.precio_venta|default_if_none:''|stringformat:'.2f' }}"></td>
                <td class="show0 {% if request.user|has_group:'Comprador' %}customerHide{% endif %}"><input type="number" name="precio_compra" step=".01" value="{{ item.precio_compra|default_if_none:''|stringformat:'.2f' }}"></td>
                <td class="{% if request.user|has_group:'Comprador' %}show0{% elif request.user|has_group:'Vendedor' %}not-show0{%endif%}">
                  <select name="tipo_pago" onchange="contadoTasa({{item.id}})" id="tp{{item.id}}">
                    <option value="" {% if item.tipo_pago == None %}selected{% endif %} disabled>Elija tipo pago</option>
                  {% for tipo_pago in tipo_pagos %}
                    <option value="{{ tipo_pago.id }}" {% if tipo_pago.nombre == item.tipo_pago.nombre and item.tipo_pago != None %}selected{% endif %}>{{ tipo_pago.nombre }}</option>
                  {% endfor %}
                  </select>
                </td>
                <td class="not-show0">
                  <select name="tasa" id="tas{{item.id}}">
                    {% for v,t in tasas %}
                    <option value="{{ v }}" {% if v == item.tasa %}selected{% endif %}{% if v == None %}selected disabled{% endif %}>{{ t }}</option>
                  {% endfor %}
                  </select>
                </td>
                <td class="not-show0"><input class="datepicker" autocomplete="off" type="text" name="fecha_pago" value="{{ item.fecha_pago|default:'' }}"></td>
                <td class="not-show0"><input class="datepicker" autocomplete="off" type="text" name="fecha_entrega" value="{{ item.fecha_entrega|default:'' }}"></td>
                <td class="not-show0">
                  <input type="text" name="destino" value="{{item.destino}}"/>
                </td>
                <td>
                  {% if not item.aceptado %}
                  <a class="action-btn btn-small bv-green btn-floating waves-effect waves-light tooltipped" data-position="top" data-tooltip="Aceptar" onclick="accept({{ forloop.counter0 }})"><i class="material-icons table-icons">done</i></a>
                  <a class="action-btn btn-small bv-red btn-floating waves-effect waves-light tooltipped" data-position="top" data-tooltip="Eliminar" onclick="reject({{ forloop.counter0 }})"><i class="material-icons table-icons">delete</i></a>
                  {% endif %}
                  <a class="action-btn btn-small bv-yellow btn-floating waves-effect waves-light tooltipped" data-position="top" data-tooltip="Guardar Ediciones" onclick="update({{ forloop.counter0 }})"><i class="material-icons table-icons">save</i></a>
                  <a class="action-btn btn-small bv-blue btn-floating waves-effect waves-light tooltipped" data-position="top" data-tooltip="Eliminar Ediciones" onclick="resetAll({{ forloop.counter0 }}, '{{ item.aceptado }}')"><i class="material-icons table-icons">undo</i></a>
                </td>
                <td>
                  <a class="action-btn btn-small bv-gray btn-floating waves-effect waves-light" id="btn-sm-1" onclick="showMore(0);"><i class="i1 material-icons table-icons">search</i></a>
                </td>
              </tr>
              <script>
                $(document).ready(function() {
                  contadoTasa("{{item.id}}");
                });
              </script>
            {% endfor %}
            {% if not negocio.aprobado %}
              <tr id="extra">
                <td class="show0">
                    <input type="hidden" id='artValue'>
                    <input type="text" name='articulo' id='artSearch' class="autocomplete">
                </td>
                <td class="show0 {% if request.user|has_group:'Comprador' %}customerHide{% endif %}">
                  <input type='text' name='distribuidor' id='distSearch' list='distResults' autocomplete='off'>
                  <datalist id='distResults'>
                  {% for dist in distribuidores %}
                    <option data-value="{{ dist.id }}" value="{{ dist.persona }}"></option>
                  {% endfor %}
                  </datalist>
                </td>
                <td class="show0"><input type="number" name="cantidad"></td>
                <td class="show0">
                  <input type="number" name="precio_venta" step=".01" placeholder="{{ item.precio_venta }}">
                </td>
                <td class="show0 {% if request.user|has_group:'Comprador' %}customerHide{% endif %}">
                  <input type="number" name="precio_compra" step=".01" placeholder="{{ item.precio_compra }}">
                </td>
                <td class="{% if request.user|has_group:'Comprador' %}show0{% elif request.user|has_group:'Vendedor' %}not-show0{%endif%}">
                  <select name="tipo_pago" onchange="contadoTasa('Add')" id="tpAdd">
                    <option value="" selected disabled>Elija tipo pago</option>
                  {% for tipo_pago in tipo_pagos %}
                    <option value="{{ tipo_pago.id }}">{{ tipo_pago.nombre }}</option>
                  {% endfor %}
                  </select>
                </td>
                <td class="not-show0">
                  <select name="tasa" id="tasAdd">
                  {% for v,t in tasas %}
                    <option value="{{ v }}" {% if v == None %}selected disabled{% endif %}>{{ t }}</option>
                  {% endfor %}
                  </select>
                </td>
                <td class="not-show0"><input class="datepicker" autocomplete="off" type="text" name="fecha_pago" value="{{ item.fecha_pago|default:'' }}"></td>
                <td class="not-show0"><input class="datepicker" autocomplete="off" type="text" name="fecha_entrega" value="{{ item.fecha_entrega|default:'' }}"></td>
                <td class="not-show0">
                  <input type="text" name="destino" value=""/>
                </td>
                <td><a class="action-btn no-shadow bv-dark-green btn-floating waves-effect waves-light tooltipped" data-position="top" data-tooltip="Agregar" onclick="addArt()"><i class="material-icons">add</i></a></td>
                <td>
                  <a class="action-btn btn-small bv-gray btn-floating waves-effect waves-light" onclick="showMore(0);"><i class="i1 material-icons table-icons">search</i></a>
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-action">
        <span class="obser">Observaciones</span>
        <textarea class="materialize-textarea" id="observaciones" name="observaciones" cols="30" rows="10">{{ prop.observaciones }}</textarea>
        <br><br>
          <a class="send-btn no-shadow bv-green waves-effect waves-light btn modal-trigger" id="send-prop-btn" href="#modalSend" onclick="beforeSubmit();"><i class="material-icons right">send</i>Enviar</a>
        </div>
    </div>
  </div>
</div>
<script>
  $("#client-view-sw").change(function() {
    if($(this).is(":checked")) {
      if (sm) {
        showMore(0);
      }
      
    }
    else {
      if (sm) {
        showMore(0);
      }
    }
    for (var i in listProp) {
      toggleClientView(listProp[i]);
    }
  });
</script>
{% endif %}
{% endfor %}

{% if negocio.aprobado %}
<div class="approved" id="approved">
  <h2>Negocio confirmado ✓</h2>
  <p><strong>Negocio cerrado: {{negocio.fecha_cierre.date}} a las {{negocio.fecha_cierre.time}}</strong></p>
  <a class="send-btn btn no-shadow waves-effect waves-effect waves-light" style="background-color: green;" id="modifyProp" onclick="addTable(); mScrollTo('#form');">Modificar propuesta</a>
</div>
{% endif %}
{% if negocio.cancelado %}
<div class="canceled" id="canceled">
  <h2>Negocio cancelado ✗</h2>
  <p><strong>Negocio cerrado: {{negocio.fecha_cierre.date}} a las {{negocio.fecha_cierre.time}}</strong></p>
</div>
{% endif %}

{% if negocio.aprobado %}
<div id="table-destination">

  <div class="materialert warning" id="infoAlert">
    <div class="material-icons">warning</div>
    Debajo aparecerán las modificaciones que se realizaron posterior a la confirmación del negocio.
    <button type="button" class="close-alert" onclick="closeAlert('#infoAlert');">×</button>
  </div>

</div>
{% endif %}

{% if not negocio.cancelado %}
<div id="modalSend" class="modal">
  <div class="modal-content">
    <h4>Enviar propuesta</h4>
    <p>Estás a punto de enviar una nueva propuesta. ¿Deseas continuar con la operación?</p>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-action modal-close waves-effect waves-red btn-flat">CANCELAR</a>
    <a onclick="submitProp()" class="modal-action modal-close waves-effect waves-green btn-flat">ENVIAR</a>
  </div>
</div>
{% endif %}

<script type="text/javascript">

  var isAccepted = false;
  var isCanceled = false;
  var modifyWasClicked = false;

  var last = {{ last | safe }};
  var edits = $.extend(deep=true, {}, last);
  var editable_fields = [
    "distribuidor",
    "precio_venta",
    "precio_compra",
    "cantidad",
    "tipo_pago",
    "tasa",
    "destino",
    "fecha_entrega",
    "fecha_pago",
    "observaciones"
  ]
  var headers = []
  var listProp = [];

  $(document).ready(function(){
    $('.datepicker').datepicker({
      format: 'dd/mm/yyyy',
    });
    $('.tooltipped').tooltip();
    $('select').formSelect();
    $("#form thead tr th").each(function(index){
      if ($(this).text() != "Operaciones" && $(this).text() != "Ver más"){
        headers.push($(this).text().toLowerCase().replace(/\s+/g, '_'));
      }
  })
    edits.new = {}

    $("#artSearch").devbridgeAutocomplete({
      serviceUrl: "{% url 'api_articulos' %}",
      paramName: "search",
      noCache: true,
      ajaxSettings: {
        method: "GET",
        dataType: "json"
      },
      transformResult: function(res){
        var data = {"suggestions":[]};
        $.map(res, (a) => {
          data.suggestions.push({
            'value': a.marca,
            'data': ""+a.id,
          })
        })
        return data;
      },
      minChars: 4,
      onSelect: function (suggestion) {
        $("#artValue").val(suggestion.data)
      },
    });

    // var btn_sm_1 = document.getElementById('btn-sm-1');
    
    // $(btn_sm_1).each(function () {
    //   $('[id="' + this.id + '"]:gt(0)').remove();
    // });

    // scroll hasta tabla editable o en su defecto, a aviso de negocio aprobado o cancelado
    var elId;
    "{% if not negocio.aprobado and not negocio.cancelado %}"
    elId = "#form-table-div"
    "{% elif negocio.aprobado and not negocio.cancelado %}"
    elId = "#approved"
    "{% elif not negocio.aprobado and negocio.cancelado %}"
    elId = "#canceled"
    "{% endif %}"
    mScrollTo(elId);

    listProp.push('0');

    "{% if negocio.aprobado %}"
    isAccepted = true;
    "{% endif %}"
    "{% if negocio.cancelado %}"
    isCanceled = true;
    "{% endif %}"

    if (isAccepted || isCanceled) {
      $("#form-table-div").hide();
    }

  });

  function mScrollTo(id) {
    var offset;
    var elementPosition = $(id).offset().top;
    var windowHeight = $(window).height();
    
    if ($(window).width() > 767) {
      offset = elementPosition - windowHeight / 2;
    }
    else {
      offset = elementPosition;
    }

    $('html, body').animate({
      scrollTop: offset
    }, 700);
  }

  var userIsComprador = false;
  "{% if request.user|has_group:'Comprador' %}"
  userIsComprador = true;
  "{% endif %}"

  if (userIsComprador) {
    $(".customerHide").hide();
  }

  function contadoTasa(aggId) {
    var tipo_pago = document.getElementById("tp"+aggId);
    var tasa = document.getElementById("tas"+aggId);
    if (tipo_pago != null) {
      var selectedText = tipo_pago.options[tipo_pago.selectedIndex].text;
      if (selectedText.toLowerCase() === "contado") {
        tasa.disabled = true;
        tasa.value = '0';
      }
      else {
        tasa.disabled = false;
      }
      $('select').formSelect();
    }
  }

  var sm = false

  function showMore(n) {

    var tdShow = $("td.show"+n);
    var thShow = $("th.show"+n);
    var tdNotShow = $("td.not-show"+n);
    var thNotShow = $("th.not-show"+n);
    // var iAnim = $("i.i"+n+"");

    thShow.toggleClass("show"+n+" not-show"+n);
    tdShow.toggleClass("show"+n+" not-show"+n);
    tdNotShow.toggleClass("not-show"+n+" show"+n);
    thNotShow.toggleClass("not-show"+n+" show"+n);
    // iAnim.toggleClass("rotate");

    if (n==0) {
      sm = !sm
    }

  }

  "{% if request.user|has_group:'Vendedor' %}"

  // funcion vista cliente
  var vistaCliente = false;

  function toggleClientView(n) {
  
    var clientView = $(".clientView");
    var clientViewSM = $(".clientViewSM");

    if($("#client-view-sw").is(":checked")) {

      clientView.show();
      clientViewSM.hide();
      $("#form-table-div").hide();
      $("#send-prop-btn").attr('disabled', true);

      vistaCliente = true;

    }
    else {

      clientView.css('display', '');
      clientViewSM.show();
      if (modifyWasClicked) {
        $("#form-table-div").show();
      }
      else if (!isAccepted) {
        $("#form-table-div").show();
      }
      $("#send-prop-btn").removeAttr('disabled');

      vistaCliente = false;

    }

    alertAnimation();

  }

  function alertAnimation() {
    var materialAlert = $(".materialert.error");

    if (vistaCliente) {
      materialAlert.css("display", "flex");
      materialAlert.css("animation", "alertAnimDown .5s ease 0s 1 normal forwards");
    }
    else {
      materialAlert.css("animation", "alertAnimUp .5s ease 0s 1 normal forwards");
      setTimeout(
        function() {
          materialAlert.css("display", "none");
        }
      , 500);
    }
  }

  "{% endif %}"

  function closeAlert(id) {
    $(id).hide();
  }

  // funcion editar despues de negocio confirmado

  function addTable() {
    $("#modifyProp").hide();
    $("#form-table-div").detach().appendTo("#table-destination");
    $("#form-table-div").show();
    modifyWasClicked = true;
  }

  function addTables(n, isBeforeFechaCierre) {
    if (!isBeforeFechaCierre) {
      $("#div-table-"+n).detach().appendTo("#table-destination");
      $("#div-table-"+n).show();
    }
  }
  
  var lastForAccept = last;

  function accept(index){
    console.log("accept")
    if (!userIsComprador) {
      var input = $($("#form")[0].rows[index+1]).find('[name="distribuidor"]')[0]
      if (edits.items[index].proveedor == null) {
        $(input).addClass("invalid");
        return;
      }
    }
    resetForAccept(index)
    edits.items[index].aceptado = true;
    $($("#form")[0].rows[index+1]).addClass("green white-text white-text-input")
  }

  function reject(index){
    console.log("rejected")
    resetAll(index, "False")
    $($("#form")[0].rows[index+1]).addClass("red white-text white-text-input")
    edits.items[index]={};
  }

  function update(index){
    console.log("update");
    if (!userIsComprador && edits.items[index].proveedor == null) {
      var input = $($("#form")[0].rows[index+1]).find('[name="distribuidor"]')[0];
      if (input.value == "") {
        $(input).addClass("invalid");
        return;
      }
      else {
        $(input).removeClass("invalid");
      }
    }
    $($("#form")[0].rows[index+1]).removeClass(["red","green","yellow","white-text","white-text-input"])
    $($("#form")[0].rows[index+1]).addClass("yellow");
    editable_fields.forEach(element => {
      if (element != "observaciones" && element != "distribuidor") {
        var input = $($("#form")[0].rows[index+1]).find('[name="'+element+'"]')[0]
        if (input.type == "number"){
          edits.items[index][element] = parseInt(input.value)
        }
        else if (input.name == "distribuidor"){
          var opt = $("#distResults [value='"+input.value+"']");
          edits.items[index]["proveedor"] = opt.data('value');
        } else {
          edits.items[index][element] = input.value
        }
      }
    })
    lastForAccept.items[index] = edits.items[index]
  }

  function resetAll(index, aceptado){
    console.log("resetAll");
    if (aceptado == "False") {
      $($("#form")[0].rows[index+1]).removeClass(["red","green","yellow","white-text","white-text-input"]);
    }
    edits.items[index] = Object.assign({},last.items[index]);
    editable_fields.forEach(element => {
      var input = $($("#form")[0].rows[index+1]).find('[name="'+element+'"]');
      if (element == "tipo_pago" || element == "tasa") {
        input.val(edits.items[index][element]).change();
      }
      else {
        input.val(edits.items[index][element]);
      }
    });
  }

  function resetForAccept(index) {
    console.log("resetForAccept");
    $($("#form")[0].rows[index+1]).removeClass(["red","green","yellow","white-text","white-text-input"]);
    edits.items[index] = Object.assign({},lastForAccept.items[index]);
    editable_fields.forEach(element => {
      var input = $($("#form")[0].rows[index+1]).find('[name="'+element+'"]')
      if (element == "tipo_pago" || element == "tasa") {
        input.val(edits.items[index][element]).change()
      }
      else if (element == "distribuidor") {
        // do nothing
      }
      else {
        input.val(edits.items[index][element])
      }
    });
  }

  var counter = 0;

  function addArt(){
    var n = {}, errors=false;
    var rowId = "NewRow"+counter
    console.log("addArt");
    headers.push("divisa");
    headers.forEach(element => {
      if (userIsComprador) {
        if (element == "precio") {
          element = "precio_venta";
        }
      }
      var input = null;
      if (element != "divisa") {
        input = $($("#extra").find('[name="'+element+'"]'))[0];
      }
      var artId = parseInt($("#artValue")[0].value);
      if (input != null) {
        if (!input.value){
          if (userIsComprador) {
            if (!(input.name == "distribuidor" || input.name == "precio_compra")) {
              errors = true;
              $(input).addClass("invalid");
            }
          }
          else {
            errors = true;
            $(input).addClass("invalid");
          }
        }
        if (element === "distribuidor"){
          element = "proveedor";
          var opt = $("#distResults [value='"+input.value+"']");
          n[element] = opt.data('value');
        } else {
          if (input.type == "number" || input.type == "hidden" || input.name == "tipo_pago"){
            n[element] = parseInt(input.value);
          }else {
            n[element] = input.value;
            n["articulo"] = artId;
            n["pagado"] = false;
            n["fecha_real_entrega"] = null;
            n["fecha_real_pago"] = null;
            n["fecha_salida_entrega"] = null;
            n["divisa"] = "USD";
            if (userIsComprador) {
              n["proveedor"] = null;
              n["precio_compra"] = 0;
            }
          }
        }
      }
    })
    if (errors){
      return;
    }
    n.aceptado = false;

    edits.items.push(n);

    var tipo_pago = "";

    "{% for tipo_pago in tipo_pagos %}"
    if (parseInt("{{tipo_pago.id}}") == n.tipo_pago) {
      tipo_pago = "{{tipo_pago.nombre}}";
    }
    "{% endfor %}"

    if (sm) {
      showMore(0);
    }

    if (tipo_pago.toLowerCase() == "contado") {
      n.tasa = 0;
    }

    var table = $("#form")[0]
    var row = table.insertRow(table.rows.length-1)
    row.innerHTML = "\
    <td class=\"show0\">"+$("#artSearch")[0].value+"</td>\
    {% if not request.user|has_group:'Comprador' %}\
    <td class=\"show0\">"+$("#distSearch")[0].value+"</td>\
    {% endif %}\
    <td class=\"show0\"><input type=\"number\" name=\"cantidad\" value=\""+n.cantidad+"\"></td>\
    <td class=\"show0\"><input type=\"number\" name=\"precio_venta\" step=\".01\" value="+n.precio_venta+"></td>\
    {% if not request.user|has_group:'Comprador' %}\
    <td class=\"show0\"><input type=\"number\" name=\"precio_compra\" step=\".01\" value=\""+n.precio_compra+"\"></td>\
    {% endif %}\
    <td class=\"{% if request.user|has_group:'Comprador' %}show0{% elif request.user|has_group:'Vendedor' %}not-show0{%endif%}\"><select name=\"tipo_pago\" id=\"tp"+rowId+"\" onchange=\"contadoTasa('"+rowId+"')\"><option value=\""+n.tipo_pago+"\" selected disabled>"+tipo_pago+"</option>{% for tipo_pago in tipo_pagos %}<option value=\"{{ tipo_pago.id }}\">{{ tipo_pago.nombre }}</option>{% endfor %}</select></td>\
    <td class=\"not-show0\"><select name=\"tasa\" id=\"tas"+rowId+"\"><option value=\""+n.tasa+"\" selected disabled>"+n.tasa+"%</option>{% for v,t in tasas %}<option value=\"{{ v }}\" {% if v == "+n.tasa+" %}selected{% endif %}{% if v == None %}disabled{% endif %}>{{ t }}</option>{% endfor %}</select></td>\
    <td class=\"not-show0\"><input type=\"text\" name=\"fecha_pago\" value=\""+n.fecha_pago+"\"></td>\
    <td class=\"not-show0\"><input type=\"text\" name=\"fecha_entrega\" value=\""+n.fecha_entrega+"\"></td>\
    <td class=\"not-show0\"><input type=\"text\" name=\"destino\" value=\""+n.destino+"\"/></td>\
    <td>\
      <a class=\"action-btn btn-small bv-red btn-floating waves-effect waves-light tooltipped\" data-position=\"top\" data-tooltip=\"Eliminar\" onclick=\"reject("+(table.rows.length-3)+")\"><i class=\"material-icons table-icons\">delete</i></a>\
      <a class=\"action-btn btn-small bv-yellow btn-floating waves-effect waves-light tooltipped\" data-position=\"top\" data-tooltip=\"Guardar Ediciones\" onclick=\"update("+(table.rows.length-3)+")\"><i class=\"material-icons table-icons\">save</i></a>\
    </td>\
    <td></td>\
    ";
    $('select').formSelect();
    headers.forEach(element => {
      if (userIsComprador) {
        if (element == "precio") {
          element = "precio_venta";
        }
      }
      var input = $($("#extra").find('[name="'+element+'"]'))
      input.val("");
      input.removeClass(["invalid"])
    })
    $('select').formSelect();
    $("#artSearch").val("");
    counter = counter + 1;
    contadoTasa(rowId);
  }

  function beforeSubmit() {
    var proc = {}
    var errors = false;
    var errorFields = [];
    proc.observaciones = $("#observaciones").val();
    proc.items = [];
    edits.items.forEach(element => {
      if (element.hasOwnProperty("articulo")){
        proc.items.push(element)
      }
    })
    var acc = []
    var count = 0;
    proc.items.forEach(element => {
      for (k in element) {
        if (k == "aceptado") {
          var v = element[k];
          acc.push(v);
        }
      }
      count++;
    })
    if (count == 0) {
      acc = [false];
    }
    var checker = arr => arr.every(Boolean);
    var modalTitle = $("#modalSend .modal-content h4");
    var modalBody = $("#modalSend .modal-content p");
    if (checker(acc)) {
      modalTitle.text("Confirmar negocio");
      modalBody.text("Estás a punto de confirmar el negocio. ¿Deseas continuar con la operación?");
    }
    else if (count == 0) {
      modalTitle.text("Cancelar negocio");
      modalBody.text("Estás a punto de cancelar el negocio. ¿Deseas continuar con la operación?");
    }
    else {
      modalTitle.text("Enviar propuesta");
      modalBody.text("Estás a punto de enviar una nueva propuesta. ¿Deseas continuar con la operación?");
    }
  }

  function submitProp() {
    var proc = {}
    var errors = false;
    var errorFields = [];
    proc.observaciones = $("#observaciones").val();
    proc.items = [];
    edits.items.forEach(element => {
      if (element.hasOwnProperty("articulo")){
        proc.items.push(element)
      }
    })
    var elems = ["id", "propuesta", "aceptado", "pagado", "fecha_real_pago", "fecha_salida_entrega", "fecha_real_entrega", "divisa", "tasa"];
    var artName = "";
    proc.items.forEach(element => {
      for (k in element) {
        if (k == "articulo") {
          "{% for art in arts %}"
            var artId = parseInt("{{art.id}}");
            if (artId == element[k]) {
              artName = "{{art.marca}}";
            }
          "{% endfor %}"
        }
        if (!(jQuery.inArray(k, elems) != -1)) {
          if (element.hasOwnProperty(k)) {
            var v = element[k];
            var errorDesc = "El campo \""+k+"\" del artículo \""+artName+"\" contiene errores."
            if (v == null || v == "" || v == undefined) {
              if (userIsComprador && ((k == "precio_compra" && (v == 0 || v == null)) || (k == "proveedor" && (v == "" || v == null)))) {
                // do nothing
              }
              errorFields.push(errorDesc);
              errors = true;
            }
          }
        }
      }
    })
    console.log(proc);
    var print_errors = "";
    for (var i = 0; i < errorFields.length; i++) {
      print_errors = print_errors.concat('\n'+errorFields[i]+'\n')
    }
    if (errors) {
      swal("Oops!", print_errors, "error");
    }
    else {
      fetch("",{
        method:'POST',
        headers: {
          [window.drf.csrfHeaderName]: window.drf.csrfToken,
          'Content-Type':'application/json',
        },
        body: JSON.stringify(proc),
      })
        .then(a => {location.reload()})
        .catch(a => {console.log(a)})
    }
  }
</script>
{%endblock body%}